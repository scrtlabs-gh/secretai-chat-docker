<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SecretAI Chat – Sample</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      font-family: 'Inter', sans-serif;
      display: flex; flex-direction: column; height: 100vh;
      background: #f0f2f5;
    }
    #chat-container {
      flex: 1; overflow-y: auto;
      padding: 1rem;
      display: flex; flex-direction: column; gap: 0.5rem;
    }
    .message { display: flex; max-width: 80%; }
    .message.user    { align-self: flex-end; }
    .message.assistant { align-self: flex-start; }
    .bubble {
      border-radius: 12px; padding: 0.75rem 1rem;
      word-wrap: break-word;
      /* PRESERVE ALL SPACES AND LINE BREAKS */
      white-space: pre-wrap;
    }
    .user .bubble {
      background: #0069d9; color: white;
      border-bottom-right-radius: 2px;
    }
    .assistant .bubble {
      background: white; color: #333;
      border-bottom-left-radius: 2px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .think i {
      font-style: italic; color: #555; opacity: 0.8;
    }
    #input-container {
      display: flex; padding: 0.5rem;
      background: white; border-top: 1px solid #ddd;
    }
    #user-input {
      flex: 1; padding: 0.75rem; border: 1px solid #ccc;
      border-radius: 8px; font-size: 1rem;
    }
    #send-btn {
      margin-left: 0.5rem; padding: 0 1rem;
      font-size: 1rem; border: none; background: #0069d9;
      color: white; border-radius: 8px; cursor: pointer;
      transition: background 0.2s;
    }
    #send-btn:disabled { background: #999; cursor: not-allowed; }
  </style>
</head>
<body>
  <div id="chat-container"></div>
  <div id="input-container">
    <input id="user-input" placeholder="Enter your message…" />
    <button id="send-btn" disabled>Send</button>
  </div>

  <script>
    const chat = document.getElementById("chat-container");
    const inp  = document.getElementById("user-input");
    const btn  = document.getElementById("send-btn");

    function appendMessage(role, html) {
      const w = document.createElement("div");
      w.classList.add("message", role);
      const b = document.createElement("div");
      b.classList.add("bubble");
      b.innerHTML = html;
      w.appendChild(b);
      chat.appendChild(w);
      chat.scrollTop = chat.scrollHeight;
      return b;
    }

    async function loadHistory() {
      const resp = await fetch("/history.json");
      if (!resp.ok) return;
      const hist = await resp.json();
      for (const [role, text] of hist) {
        if (role === "assistant") {
          const m = text.match(/<think>([\s\S]*?)<\/think>/);
          if (m) {
            const after = text.replace(/<think>[\s\S]*?<\/think>/, "");
            appendMessage("assistant",
              `<span class="think"><i>${m[1]}</i>&nbsp;</span>` +
              `<span class="normal">${after}</span>`
            );
          } else {
            appendMessage("assistant", text);
          }
        } else {
          appendMessage("user", text);
        }
      }
      chat.scrollTop = chat.scrollHeight;
    }

    let ws, thinkSpan, normalSpan;
    let first=true, hasThink=false, done=false, buf="";

    function connect() {
      const proto = location.protocol==="https:"?"wss":"ws";
      ws = new WebSocket(`${proto}://${location.host}/ws`);
      ws.onopen    = () => btn.disabled=false;
      ws.onclose   = () => { btn.disabled=true; setTimeout(connect,1000) };
      ws.onerror   = e => { console.error(e); ws.close() };
      ws.onmessage = e => handleChunk(JSON.parse(e.data).chunk);
    }

    function handleChunk(token) {
      if (first) {
        hasThink = token.includes("<think>");
        if (!hasThink) done = true;
        first = false;
      }
      buf += token;
      if (!done && hasThink) {
        const idx = buf.indexOf("</think>");
        if (idx!==-1) {
          const before = buf.slice(0,idx).replace(/<think>/g,"");
          const after  = buf.slice(idx+8);
          thinkSpan.innerHTML = `<i>${before}</i>&nbsp;`;
          normalSpan.textContent = after;
          done = true; buf = after;
        } else {
          const inside = buf.replace(/<think>/g,"");
          thinkSpan.innerHTML = `<i>${inside}</i>&nbsp;`;
        }
      } else {
        normalSpan.textContent += token;
      }
      chat.scrollTop = chat.scrollHeight;
    }

    function send() {
      const txt = inp.value.trim();
      if (!txt||ws.readyState!==WebSocket.OPEN) return;
      appendMessage("user", txt);
      inp.value=""; btn.disabled=true;
      first=true; hasThink=false; done=false; buf="";
      const bubble = appendMessage("assistant",
        `<span class="think"></span><span class="normal"></span>`
      );
      thinkSpan  = bubble.querySelector(".think");
      normalSpan = bubble.querySelector(".normal");
      ws.send(txt);
    }

    btn.addEventListener("click", send);
    inp.addEventListener("keydown", e=>{ if(e.key==="Enter"){e.preventDefault();send()} });

    loadHistory();
    connect();
  </script>
</body>
</html>
